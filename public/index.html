 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Video Call - WhatsApp Style</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * {
      font-family: 'Inter', sans-serif;
    }
    
    .call-button {
      @apply w-14 h-14 rounded-full flex items-center justify-center transition-all duration-300 shadow-lg backdrop-blur-sm;
    }
    
    .call-button:active {
      @apply scale-95;
    }
    
    .glass-effect {
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .pulse-animation {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.8; }
    }
    
    .slide-up {
      animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .video-container {
      position: relative;
      overflow: hidden;
      border-radius: 0;
    }
    
    @media (min-width: 768px) {
      .video-container {
        border-radius: 1rem;
      }
    }
    
    .floating-controls {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
      padding: 2rem 1rem 2rem;
      z-index: 30;
    }
    
    @media (min-width: 768px) {
      .floating-controls {
        position: absolute;
        bottom: 2rem;
        left: 50%;
        right: auto;
        transform: translateX(-50%);
        background: transparent;
        padding: 0;
      }
    }
    
    .chat-panel {
      transform: translateX(100%);
      transition: transform 0.3s ease-in-out;
    }
    
    .chat-panel.open {
      transform: translateX(0);
    }
  </style>
</head>

<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-black text-white relative h-screen overflow-hidden">
  
  <!-- Status Bar -->
  <div class="fixed top-0 left-0 right-0 z-50 flex justify-between items-center p-4 glass-effect">
    <div class="flex items-center space-x-2">
      <div class="w-3 h-3 rounded-full bg-green-400 pulse-animation"></div>
      <span class="text-sm font-medium" id="connectionStatus">Connected</span>
    </div>
    
    <div class="flex items-center space-x-4">
      <div class="flex items-center space-x-1" id="networkIndicator">
        <i class="fas fa-signal text-green-400"></i>
        <span class="text-xs" id="networkQuality">HD</span>
      </div>
      
      <div class="text-sm font-mono" id="callTimer">00:00</div>
    </div>
  </div>

  <!-- Incoming Call Modal -->
  <div id="incomingCallModal" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center">
    <div class="text-center slide-up max-w-sm mx-auto p-6">
      <div class="mb-6">
        <div class="w-32 h-32 mx-auto rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center mb-4 pulse-animation">
          <i class="fas fa-user text-4xl text-white"></i>
        </div>
        <h2 class="text-2xl font-semibold mb-2">Incoming Call</h2>
        <p class="text-gray-300" id="callerInfo">Unknown Caller</p>
      </div>
      
      <div class="flex justify-center space-x-8">
        <button id="declineCall" class="call-button bg-red-500 hover:bg-red-600">
          <i class="fas fa-phone-slash text-xl"></i>
        </button>
        <button id="acceptCall" class="call-button bg-green-500 hover:bg-green-600">
          <i class="fas fa-phone text-xl"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Main Video Container -->
  <div class="relative h-full">
    <!-- Remote Video (Full Screen) -->
    <div class="video-container h-full bg-gray-900 relative">
      <video id="remoteVideo" autoplay playsinline class="w-full h-full object-cover"></video>
      
      <!-- No Video Placeholder -->
      <div id="remoteVideoPlaceholder" class="absolute inset-0 flex items-center justify-center bg-gradient-to-br from-gray-700 to-gray-900">
        <div class="text-center">
          <div class="w-24 h-24 mx-auto rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center mb-4">
            <i class="fas fa-user text-3xl text-white"></i>
          </div>
          <p class="text-lg font-medium">Waiting for connection...</p>
          <p class="text-sm text-gray-400" id="waitingMessage">Connecting to peer</p>
        </div>
      </div>
    </div>

    <!-- Local Video (Picture-in-Picture) -->
    <div class="fixed top-20 right-4 w-24 h-32 md:w-32 md:h-44 lg:w-40 lg:h-56 rounded-xl overflow-hidden shadow-2xl z-20 transition-all duration-300" id="localVideoContainer">
      <video id="localVideo" autoplay muted playsinline class="w-full h-full object-cover"></video>
      <button id="switchCamera" class="absolute top-2 right-2 w-8 h-8 rounded-full bg-black/50 flex items-center justify-center">
        <i class="fas fa-sync-alt text-xs"></i>
      </button>
    </div>

    <!-- Participant Info -->
    <div class="absolute top-20 left-4 right-4 z-20 fade-in" id="participantInfo">
      <div class="glass-effect rounded-xl p-4 max-w-xs">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
            <i class="fas fa-user text-sm"></i>
          </div>
          <div>
            <p class="font-medium" id="participantName">Participant</p>
            <p class="text-xs text-gray-300" id="participantId">ID: <span id="displayParticipantId">----</span></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Call Controls -->
    <div class="floating-controls">
      <div class="flex justify-center items-center space-x-4 md:space-x-6">
        
        <!-- Chat Button -->
        <button id="toggleChat" class="call-button bg-gray-600/80 hover:bg-gray-500/80 relative">
          <i class="fas fa-comment text-lg"></i>
          <span id="chatNotification" class="hidden absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-xs flex items-center justify-center">!</span>
        </button>

        <!-- Screen Share Button -->
        <button id="shareScreen" class="call-button bg-gray-600/80 hover:bg-gray-500/80">
          <i class="fas fa-desktop text-lg"></i>
        </button>

        <!-- Mute Button -->
        <button id="toggleMute" class="call-button bg-gray-600/80 hover:bg-gray-500/80" data-enabled="true">
          <i class="fas fa-microphone text-lg"></i>
        </button>

        <!-- End Call Button -->
        <button id="endCall" class="call-button bg-red-500 hover:bg-red-600 w-16 h-16 hidden">
          <i class="fas fa-phone-slash text-xl"></i>
        </button>

        <!-- Video Toggle Button -->
        <button id="toggleVideo" class="call-button bg-gray-600/80 hover:bg-gray-500/80" data-enabled="true">
          <i class="fas fa-video text-lg"></i>
        </button>

        <!-- More Options -->
        <button id="moreOptions" class="call-button bg-gray-600/80 hover:bg-gray-500/80">
          <i class="fas fa-ellipsis-v text-lg"></i>
        </button>

      </div>
    </div>

    <!-- Pre-Call Interface -->
    <div id="preCallInterface" class="absolute inset-0 bg-gradient-to-br from-gray-900 via-gray-800 to-black flex items-center justify-center z-10">
      <div class="text-center max-w-md mx-auto p-6">
        <h1 class="text-3xl font-bold mb-2">Video Call</h1>
        <p class="text-gray-400 mb-8">Connect with anyone, anywhere</p>
        
        <div class="glass-effect rounded-2xl p-6 mb-6">
          <p class="text-sm text-gray-300 mb-2">Your ID</p>
          <div class="text-2xl font-mono text-blue-400 mb-4" id="myPeerId">----</div>
          
          <div class="space-y-4">
            <div>
              <input
                type="text"
                id="peerIdInput"
                placeholder="Enter 4-digit ID"
                class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 focus:outline-none focus:border-blue-400 text-center text-lg font-mono"
                maxlength="4"
                pattern="[0-9]{4}"
              />
            </div>
            
            <button
              id="callButton"
              class="w-full py-3 bg-gradient-to-r from-green-500 to-green-600 rounded-xl font-semibold hover:from-green-600 hover:to-green-700 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
            >
              <i class="fas fa-phone mr-2"></i>
              Start Call
            </button>
          </div>
        </div>
        
        <div class="text-xs text-gray-500">
          <p>Share your ID with others to receive calls</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Panel -->
  <div id="chatPanel" class="chat-panel fixed top-0 right-0 w-full md:w-80 h-full bg-gray-900/95 backdrop-blur-sm z-40">
    <div class="flex flex-col h-full">
      <!-- Chat Header -->
      <div class="flex items-center justify-between p-4 border-b border-gray-700">
        <h3 class="font-semibold">Chat</h3>
        <button id="closeChatPanel" class="text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <!-- Messages -->
      <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3">
        <!-- Messages will be added here -->
      </div>
      
      <!-- Chat Input -->
      <div class="p-4 border-t border-gray-700">
        <div class="flex space-x-2">
          <input
            type="text"
            id="chatInput"
            placeholder="Type a message..."
            class="flex-1 px-3 py-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none focus:border-blue-400"
          />
          <button id="sendMessage" class="px-4 py-2 bg-blue-500 rounded-lg hover:bg-blue-600">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- More Options Menu -->
  <div id="moreOptionsMenu" class="hidden fixed bottom-24 right-4 glass-effect rounded-xl p-2 z-30">
    <button id="toggleSpeaker" class="w-full text-left px-4 py-2 hover:bg-white/10 rounded flex items-center space-x-3">
      <i class="fas fa-volume-up w-4"></i>
      <span>Speaker</span>
    </button>
    <button id="togglePiP" class="w-full text-left px-4 py-2 hover:bg-white/10 rounded flex items-center space-x-3">
      <i class="fas fa-external-link-alt w-4"></i>
      <span>Picture in Picture</span>
    </button>
  </div>

  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
  <script>
    class ModernVideoCall {
      constructor() {
        this.currentCall = null;
        this.localStream = null;
        this.isVideoEnabled = true;
        this.isAudioEnabled = true;
        this.isScreenSharing = false;
        this.currentResolution = '1280x720';
        this.callStartTime = null;
        this.callTimerInterval = null;
        this.networkCheckInterval = null;
        this.currentFacingMode = 'user';
        this.chatMessages = [];
        
        this.initializePeer();
        this.setupEventListeners();
        this.initializeMedia();
      }

      generateNumericId() {
        return Math.floor(1000 + Math.random() * 9000).toString();
      }

      initializePeer() {
        const iceServers = [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:stun1.l.google.com:3478" },
          { urls: "turn:global.relay.metered.ca:80", username: "5ee7cfc816da5c0395dd306e", credential: "TUQP0WknEKBhwTkG" }
        ];

        this.peer = new Peer(this.generateNumericId(), {
          debug: 0,
          config: { iceServers }
        });

        this.peer.on('open', (id) => {
          document.getElementById('myPeerId').textContent = id;
          this.startNetworkMonitoring();
        });

        this.peer.on('call', (call) => {
          this.handleIncomingCall(call);
        });

        this.peer.on('error', (err) => {
          console.error('PeerJS Error:', err);
          this.showNotification(`Connection Error: ${err.type}`, 'error');
        });
      }

      async initializeMedia() {
        try {
          this.localStream = await navigator.mediaDevices.getUserMedia({
            video: { 
              width: { ideal: 1280 }, 
              height: { ideal: 720 },
              facingMode: this.currentFacingMode
            },
            audio: { 
              noiseSuppression: true, 
              echoCancellation: true,
              autoGainControl: true
            }
          });

          document.getElementById('localVideo').srcObject = this.localStream;
          return true;
        } catch (error) {
          console.error('Media Error:', error);
          this.showNotification('Camera/microphone access required!', 'error');
          return false;
        }
      }

      setupEventListeners() {
        // Pre-call interface
        document.getElementById('peerIdInput').addEventListener('input', (e) => {
          e.target.value = e.target.value.replace(/\D/g, '').slice(0, 4);
          document.getElementById('callButton').disabled = e.target.value.length !== 4;
        });

        document.getElementById('callButton').addEventListener('click', () => {
          this.initiateCall();
        });

        // Call controls
        document.getElementById('endCall').addEventListener('click', () => {
          this.endCall();
        });

        document.getElementById('toggleMute').addEventListener('click', () => {
          this.toggleMute();
        });

        document.getElementById('toggleVideo').addEventListener('click', () => {
          this.toggleVideo();
        });

        document.getElementById('shareScreen').addEventListener('click', () => {
          this.toggleScreenShare();
        });

        document.getElementById('switchCamera').addEventListener('click', () => {
          this.switchCamera();
        });

        // Chat functionality
        document.getElementById('toggleChat').addEventListener('click', () => {
          this.toggleChat();
        });

        document.getElementById('closeChatPanel').addEventListener('click', () => {
          this.toggleChat();
        });

        document.getElementById('sendMessage').addEventListener('click', () => {
          this.sendChatMessage();
        });

        document.getElementById('chatInput').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            this.sendChatMessage();
          }
        });

        // More options
        document.getElementById('moreOptions').addEventListener('click', () => {
          this.toggleMoreOptions();
        });

        document.getElementById('togglePiP').addEventListener('click', () => {
          this.togglePictureInPicture();
        });

        // Incoming call modal
        document.getElementById('acceptCall').addEventListener('click', () => {
          this.acceptIncomingCall();
        });

        document.getElementById('declineCall').addEventListener('click', () => {
          this.declineIncomingCall();
        });

        // Window events
        window.addEventListener('beforeunload', () => {
          this.cleanup();
        });

        // Click outside to close menus
        document.addEventListener('click', (e) => {
          if (!e.target.closest('#moreOptionsMenu') && !e.target.closest('#moreOptions')) {
            document.getElementById('moreOptionsMenu').classList.add('hidden');
          }
        });
      }

      async initiateCall() {
        const partnerId = document.getElementById('peerIdInput').value.trim();
        if (partnerId.length !== 4) return;

        if (!this.localStream) {
          const success = await this.initializeMedia();
          if (!success) return;
        }

        this.showCallInterface();
        this.updateConnectionStatus('Calling...');

        const call = this.peer.call(partnerId, this.localStream);
        this.currentCall = call;

        call.on('stream', (remoteStream) => {
          this.handleRemoteStream(remoteStream);
        });

        call.on('close', () => {
          this.endCall();
        });

        call.on('error', (err) => {
          console.error('Call Error:', err);
          this.showNotification('Call failed to connect', 'error');
          this.endCall();
        });

        this.startCallTimer();
      }

      handleIncomingCall(call) {
        this.incomingCall = call;
        document.getElementById('callerInfo').textContent = `ID: ${call.peer}`;
        document.getElementById('incomingCallModal').classList.remove('hidden');
      }

      async acceptIncomingCall() {
        document.getElementById('incomingCallModal').classList.add('hidden');

        if (!this.localStream) {
          const success = await this.initializeMedia();
          if (!success) {
            this.incomingCall.close();
            return;
          }
        }

        this.showCallInterface();
        this.incomingCall.answer(this.localStream);
        this.currentCall = this.incomingCall;

        this.currentCall.on('stream', (remoteStream) => {
          this.handleRemoteStream(remoteStream);
        });

        this.currentCall.on('close', () => {
          this.endCall();
        });

        this.startCallTimer();
      }

      declineIncomingCall() {
        document.getElementById('incomingCallModal').classList.add('hidden');
        if (this.incomingCall) {
          this.incomingCall.close();
          this.incomingCall = null;
        }
      }

      handleRemoteStream(remoteStream) {
        document.getElementById('remoteVideo').srcObject = remoteStream;
        document.getElementById('remoteVideoPlaceholder').style.display = 'none';
        document.getElementById('displayParticipantId').textContent = this.currentCall.peer;
        this.updateConnectionStatus('Connected');
      }

      showCallInterface() {
        document.getElementById('preCallInterface').style.display = 'none';
        document.getElementById('endCall').classList.remove('hidden');
        document.getElementById('participantInfo').style.display = 'block';
      }

      endCall() {
        if (this.currentCall) {
          this.currentCall.close();
          this.currentCall = null;
        }

        document.getElementById('remoteVideo').srcObject = null;
        document.getElementById('remoteVideoPlaceholder').style.display = 'flex';
        document.getElementById('endCall').classList.add('hidden');
        document.getElementById('preCallInterface').style.display = 'flex';
        document.getElementById('participantInfo').style.display = 'none';
        
        this.stopCallTimer();
        this.updateConnectionStatus('Disconnected');
        
        // Reset UI states
        this.resetCallStates();
      }

      toggleMute() {
        this.isAudioEnabled = !this.isAudioEnabled;
        if (this.localStream) {
          this.localStream.getAudioTracks()[0].enabled = this.isAudioEnabled;
        }
        
        const button = document.getElementById('toggleMute');
        const icon = button.querySelector('i');
        
        if (this.isAudioEnabled) {
          button.className = button.className.replace('bg-red-500