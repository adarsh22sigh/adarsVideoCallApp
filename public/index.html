 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title> Video Call</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- React Dependencies -->
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  
  <!-- PeerJS -->
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  
  <!-- React Bootstrap -->
  <script src="https://unpkg.com/react-bootstrap@2.7.2/dist/react-bootstrap.min.js"></script>

  <style>
    .video-container {
      position: relative;
      background: #000;
      height: 100vh;
      overflow: hidden;
    }

    .local-video {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 120px;
      height: 160px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      z-index: 2;
    }

    .remote-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .controls {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      z-index: 3;
    }

    .call-button {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .call-info {
      position: absolute;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      color: white;
      z-index: 2;
    }

    .dialer-box {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 2rem;
      max-width: 400px;
      width: 90%;
    }

    .peer-id-display {
      font-size: 1.5rem;
      letter-spacing: 3px;
      background: rgba(255, 255, 255, 0.1);
      padding: 10px 20px;
      border-radius: 10px;
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const { Modal, Button, Badge, Container, Row, Col } = ReactBootstrap;

    function App() {
      const [localStream, setLocalStream] = useState(null);
      const [remoteStream, setRemoteStream] = useState(null);
      const [peerId, setPeerId] = useState('');
      const [callStatus, setCallStatus] = useState('disconnected');
      const [incomingCall, setIncomingCall] = useState(null);
      const [isVideoEnabled, setIsVideoEnabled] = useState(true);
      const [isAudioEnabled, setIsAudioEnabled] = useState(true);
      const [callDuration, setCallDuration] = useState(0);
      const [remoteIdInput, setRemoteIdInput] = useState('');
      
      const localVideoRef = useRef(null);
      const remoteVideoRef = useRef(null);
      const peerInstance = useRef(null);
      const callTimer = useRef(null);

      useEffect(() => {
        const generatePeerId = () => Math.floor(1000 + Math.random() * 9000).toString();

        const initializePeer = async () => {
          const newPeerId = generatePeerId();
          const peer = new Peer(newPeerId, {
            debug: 3,
            config: {
              iceServers: [
                { urls: "stun:stun.l.google.com:19302" },
                { urls: "turn:relay1.expressturn.com:3478", username: 'efKLQI74W7P77IQDR9', credential: '7x8L7fKSlBh2Af72' }
              ]
            }
          });

          peer.on('open', () => {
            setPeerId(newPeerId);
          });

          peer.on('call', (call) => {
            setIncomingCall(call);
            setCallStatus('ringing');
          });

          peer.on('error', (err) => {
            console.error('PeerJS Error:', err);
          });

          peerInstance.current = peer;
        };

        initializePeer();
        initMedia();

        return () => {
          if (peerInstance.current) peerInstance.current.destroy();
          if (localStream) localStream.getTracks().forEach(track => track.stop());
          clearInterval(callTimer.current);
        };
      }, []);

      const initMedia = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { width: { ideal: 1280 }, height: { ideal: 720 } },
            audio: { noiseSuppression: true, echoCancellation: true }
          });
          setLocalStream(stream);
          if (localVideoRef.current) localVideoRef.current.srcObject = stream;
        } catch (error) {
          console.error('Error accessing media devices:', error);
        }
      };

      const startCall = () => {
        if (!remoteIdInput || remoteIdInput.length !== 4) return;
        
        const call = peerInstance.current.call(remoteIdInput, localStream);
        call.on('stream', (remoteStream) => {
          setRemoteStream(remoteStream);
          setCallStatus('connected');
          startCallTimer();
        });
        setIncomingCall(null);
      };

      const answerCall = () => {
        incomingCall.answer(localStream);
        incomingCall.on('stream', (remoteStream) => {
          setRemoteStream(remoteStream);
          setCallStatus('connected');
          startCallTimer();
        });
        setIncomingCall(null);
      };

      const endCall = () => {
        if (incomingCall) incomingCall.close();
        setCallStatus('disconnected');
        setRemoteStream(null);
        clearInterval(callTimer.current);
        setCallDuration(0);
        setRemoteIdInput('');
      };

      const toggleMedia = (type) => {
        if (type === 'video') {
          const videoTrack = localStream.getVideoTracks()[0];
          videoTrack.enabled = !videoTrack.enabled;
          setIsVideoEnabled(videoTrack.enabled);
        } else {
          const audioTrack = localStream.getAudioTracks()[0];
          audioTrack.enabled = !audioTrack.enabled;
          setIsAudioEnabled(audioTrack.enabled);
        }
      };

      const startCallTimer = () => {
        callTimer.current = setInterval(() => {
          setCallDuration(prev => prev + 1);
        }, 1000);
      };

      const formatTime = (seconds) => {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      };

      return (
        <Container fluid className="video-container">
          {remoteStream ? (
            <video ref={remoteVideoRef} autoPlay playsInline className="remote-video" />
          ) : (
            <div className="call-info">
              <h2 className="mb-3">Your ID: {peerId}</h2>
              {callStatus === 'connected' && <h3>{formatTime(callDuration)}</h3>}
            </div>
          )}

          {localStream && (
            <video
              ref={localVideoRef}
              autoPlay
              muted
              playsInline
              className="local-video"
              style={{ opacity: isVideoEnabled ? 1 : 0.5 }}
            />
          )}

          {callStatus === 'connected' ? (
            <div className="controls">
              <Button
                variant={isVideoEnabled ? 'light' : 'secondary'}
                onClick={() => toggleMedia('video')}
                className="call-button"
              >
                {isVideoEnabled ? 'üì∑' : 'üì∑‚ùå'}
              </Button>
              <Button
                variant="danger"
                onClick={endCall}
                className="call-button"
              >
                üìû
              </Button>
              <Button
                variant={isAudioEnabled ? 'light' : 'secondary'}
                onClick={() => toggleMedia('audio')}
                className="call-button"
              >
                {isAudioEnabled ? 'üé§' : 'üîá'}
              </Button>
            </div>
          ) : (
            <div className="position-absolute top-50 start-50 translate-middle">
              <div className="dialer-box text-center">
                <h3 className="text-white mb-4">Make a Call</h3>
                <div className="peer-id-display d-inline-block">{peerId}</div>
                <input
                  type="number"
                  placeholder="Enter 4-digit ID"
                  className="form-control mb-3 text-center"
                  value={remoteIdInput}
                  onChange={(e) => setRemoteIdInput(e.target.value.slice(0, 4))}
                  maxLength="4"
                />
                <Button
                  variant="success"
                  onClick={startCall}
                  className="w-100 py-2"
                  disabled={remoteIdInput.length !== 4}
                >
                  Call
                </Button>
              </div>
            </div>
          )}

          <Modal show={callStatus === 'ringing'} centered className="text-center">
            <Modal.Body className="bg-dark text-white">
              <h3 className="mb-4">Incoming Call</h3>
              <p>From: {incomingCall?.peer}</p>
              <div className="d-flex justify-content-center gap-3">
                <Button variant="danger" onClick={endCall} className="call-button">
                  ‚úñ
                </Button>
                <Button variant="success" onClick={answerCall} className="call-button">
                  ‚úî
                </Button>
              </div>
            </Modal.Body>
          </Modal>
        </Container>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
