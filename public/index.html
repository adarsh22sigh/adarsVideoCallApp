import React, { useState, useEffect, useRef } from 'react';
import { Modal, Button, Badge, Container, Row, Col } from 'react-bootstrap';
import Peer from 'peerjs';
import 'bootstrap/dist/css/bootstrap.min.css';
import './App.css';

function App() {
  const [localStream, setLocalStream] = useState(null);
  const [remoteStream, setRemoteStream] = useState(null);
  const [peerId, setPeerId] = useState('');
  const [callStatus, setCallStatus] = useState('disconnected');
  const [incomingCall, setIncomingCall] = useState(null);
  const [isVideoEnabled, setIsVideoEnabled] = useState(true);
  const [isAudioEnabled, setIsAudioEnabled] = useState(true);
  const [networkQuality, setNetworkQuality] = useState('good');
  const [callDuration, setCallDuration] = useState(0);
  const [showDialer, setShowDialer] = useState(true);
  
  const localVideoRef = useRef(null);
  const remoteVideoRef = useRef(null);
  const peerInstance = useRef(null);
  const callTimer = useRef(null);

  useEffect(() => {
    const initializePeer = async () => {
      const peer = new Peer({
        debug: 3,
        config: {
          iceServers: [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "turn:relay1.expressturn.com:3478", username: 'efKLQI74W7P77IQDR9', credential: '7x8L7fKSlBh2Af72' }
          ]
        }
      });

      peer.on('open', (id) => {
        setPeerId(id);
      });

      peer.on('call', (call) => {
        setIncomingCall(call);
        setCallStatus('ringing');
      });

      peer.on('error', (err) => {
        console.error('PeerJS Error:', err);
      });

      peerInstance.current = peer;
    };

    initializePeer();
    initMedia();
    startNetworkMonitoring();

    return () => {
      if (peerInstance.current) peerInstance.current.destroy();
      if (localStream) localStream.getTracks().forEach(track => track.stop());
      clearInterval(callTimer.current);
    };
  }, []);

  const initMedia = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { width: 1280, height: 720 },
        audio: { noiseSuppression: true, echoCancellation: true }
      });
      setLocalStream(stream);
      if (localVideoRef.current) localVideoRef.current.srcObject = stream;
    } catch (error) {
      console.error('Error accessing media devices:', error);
    }
  };

  const startCall = (remoteId) => {
    const call = peerInstance.current.call(remoteId, localStream);
    call.on('stream', (remoteStream) => {
      setRemoteStream(remoteStream);
      setCallStatus('connected');
      startCallTimer();
    });
    setIncomingCall(null);
    setShowDialer(false);
  };

  const answerCall = () => {
    incomingCall.answer(localStream);
    incomingCall.on('stream', (remoteStream) => {
      setRemoteStream(remoteStream);
      setCallStatus('connected');
      startCallTimer();
    });
    setIncomingCall(null);
    setShowDialer(false);
  };

  const endCall = () => {
    if (incomingCall) incomingCall.close();
    setCallStatus('disconnected');
    setRemoteStream(null);
    setShowDialer(true);
    clearInterval(callTimer.current);
    setCallDuration(0);
  };

  const toggleMedia = (type) => {
    if (type === 'video') {
      const videoTrack = localStream.getVideoTracks()[0];
      videoTrack.enabled = !videoTrack.enabled;
      setIsVideoEnabled(videoTrack.enabled);
    } else {
      const audioTrack = localStream.getAudioTracks()[0];
      audioTrack.enabled = !audioTrack.enabled;
      setIsAudioEnabled(audioTrack.enabled);
    }
  };

  const startNetworkMonitoring = () => {
    setInterval(() => {
      const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      if (connection) {
        setNetworkQuality(connection.downlink > 1.5 ? 'good' : 'poor');
      }
    }, 3000);
  };

  const startCallTimer = () => {
    callTimer.current = setInterval(() => {
      setCallDuration(prev => prev + 1);
    }, 1000);
  };

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  return (
    <Container fluid className="vh-100 bg-dark text-light position-relative">
      {/* Network Status */}
      <div className="position-absolute top-0 end-0 m-3">
        <Badge bg={networkQuality === 'good' ? 'success' : 'warning'}>
          {networkQuality === 'good' ? 'ğŸ“¶ Good Connection' : 'ğŸ“¶ Poor Connection'}
        </Badge>
      </div>

      {/* Main Video Area */}
      <Row className="h-100">
        <Col className="position-relative">
          {remoteStream && (
            <video
              ref={remoteVideoRef}
              autoPlay
              playsInline
              className="h-100 w-100 object-fit-cover"
            />
          )}
          
          {/* Local Video Preview */}
          {localStream && (
            <div className="position-absolute bottom-0 end-0 m-3" style={{ width: '20%', height: '30%' }}>
              <video
                ref={localVideoRef}
                autoPlay
                muted
                playsInline
                className="h-100 w-100 rounded-3 shadow-lg"
              />
            </div>
          )}

          {/* Call Controls */}
          <div className="position-absolute bottom-0 start-50 translate-middle-x mb-3">
            <div className="d-flex gap-2">
              <Button
                variant={isVideoEnabled ? 'secondary' : 'danger'}
                onClick={() => toggleMedia('video')}
                className="rounded-circle p-3"
              >
                {isVideoEnabled ? 'ğŸ“·' : 'âŒ'}
              </Button>
              
