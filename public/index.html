<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Call</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
  
  <!-- PeerJS -->
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col">

  <header class="w-full bg-gray-800 p-4 flex justify-between items-center">
    <h1 class="text-lg font-bold">Video Call</h1>
    <button id="start-call" class="bg-green-500 px-4 py-2 rounded hover:bg-green-600">Start Call</button>
    <button id="end-call" class="bg-red-500 px-4 py-2 rounded hover:bg-red-600 hidden">End Call</button>
  </header>

  <div class="flex-grow flex flex-col items-center justify-center">
    <p id="call-status" class="text-gray-400 mb-4">Click "Start Call" to initiate a video call.</p>
    <div id="video-grid" class="flex flex-wrap gap-4 justify-center"></div>

    <!-- Incoming Call Modal -->
    <div id="incoming-call" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
      <div class="bg-gray-800 p-6 rounded-lg text-center">
        <p class="text-xl text-white mb-4">Incoming Call!</p>
        <button id="answer-call" class="bg-green-500 px-6 py-3 rounded hover:bg-green-600">Answer</button>
        <button id="reject-call" class="bg-red-500 px-6 py-3 rounded hover:bg-red-600 mt-4">Reject</button>
      </div>
    </div>
  </div>

  <script>
    const socket = io();  // Adjust this URL when necessary

    const videoGrid = document.getElementById("video-grid");
    const callStatus = document.getElementById("call-status");
    const startCallButton = document.getElementById("start-call");
    const endCallButton = document.getElementById("end-call");
    const incomingCallModal = document.getElementById("incoming-call");
    const answerCallButton = document.getElementById("answer-call");
    const rejectCallButton = document.getElementById("reject-call");

    const myVideo = document.createElement("video");
    myVideo.muted = true;

    const peer = new Peer();
    const peers = {};
    let myVideoStream;
    let callActive = false;

    // PeerJS: On connection
    peer.on("open", (id) => {
      startCallButton.classList.remove("hidden");
      callStatus.textContent = "Ready to initiate a call.";
    });

    // Get the current room ID from the URL path
    const roomId = window.location.pathname.slice(1);

    socket.emit("join-room", roomId, peer.id); // Join the room
    socket.emit("start-call", roomId, peer.id); // Notify other users in the room

    // When starting a call
    startCallButton.addEventListener("click", () => {
      navigator.mediaDevices
        .getUserMedia({ video: true, audio: true })
        .then((stream) => {
          myVideoStream = stream;
          callActive = true;
          addVideoStream(myVideo, stream);

          startCallButton.classList.add("hidden");
          endCallButton.classList.remove("hidden");
          callStatus.textContent = "Call in progress...";

          socket.emit("join-room", roomId, peer.id);

          peer.on("call", (call) => {
            call.answer(stream);
            const video = document.createElement("video");
            call.on("stream", (userVideoStream) => {
              addVideoStream(video, userVideoStream);
            });
          });

          socket.on("user-connected", (userId) => {
            connectToNewUser(userId, stream);
          });

          socket.on("user-disconnected", (userId) => {
            if (peers[userId]) peers[userId].close();
          });
        })
        .catch((err) => {
          callStatus.textContent = "Failed to access camera or microphone.";
          console.error(err);
        });
    });

    // Incoming Call: Show the modal
    socket.on("call-incoming", (userId) => {
      callStatus.textContent = `User ${userId} is calling!`;
      incomingCallModal.classList.remove("hidden");

      answerCallButton.addEventListener("click", () => {
        answerCall(userId);
        incomingCallModal.classList.add("hidden");
      });

      rejectCallButton.addEventListener("click", () => {
        rejectCall(userId);
        incomingCallModal.classList.add("hidden");
      });
    });

    // Answer the call
    function answerCall(userId) {
      navigator.mediaDevices
        .getUserMedia({ video: true, audio: true })
        .then((stream) => {
          const call = peer.call(userId, stream);
          const video = document.createElement("video");
          call.on("stream", (userVideoStream) => {
            addVideoStream(video, userVideoStream);
          });

          addVideoStream(myVideo, stream);
          callActive = true;
        })
        .catch((err) => {
          console.error("Error answering call:", err);
        });
    }

    // Reject the call (close the peer connection)
    function rejectCall(userId) {
      if (peers[userId]) {
        peers[userId].close();
        callStatus.textContent = "Call rejected.";
      }
    }

    // Connect to a new user
    function connectToNewUser(userId, stream) {
      const call = peer.call(userId, stream);
      const video = document.createElement("video");
      call.on("stream", (userVideoStream) => {
        addVideoStream(video, userVideoStream);
      });
      call.on("close", () => {
        video.remove();
      });

      peers[userId] = call;
    }

    // Add video stream to the DOM
    function addVideoStream(video, stream) {
      video.srcObject = stream;
      video.className = "rounded shadow-lg";
      video.addEventListener("loadedmetadata", () => {
        video.play();
      });
      videoGrid.append(video);
    }
  </script>
</body>
</html>
